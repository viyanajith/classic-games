<!DOCTYPE html>
<html>
<head>
  <title>Full Game with Mirror & Win</title>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      background: #000;
    }
    canvas {
      display: block;
    }
    h1 {
      position: absolute;
      top: 40%;
      width: 100%;
      text-align: center;
      color: white;
      font-size: 4rem;
      display: none;
    }
  </style>
</head>
<body>
<canvas id="game"></canvas>
<h1 id="message">You Died</h1>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
const message = document.getElementById("message");

canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

let gravity = 0.5;
const jumpStrength = -12;
const floorHeight = 50;
const ceilingHeight = 50;

const player = {
  width: 50,
  height: 50,
  x: canvas.width / 2 - 25,
  y: canvas.height - floorHeight - 50,
  ySpeed: 0,
  isJumping: false
};

const spike = {
  x: canvas.width + 100,
  y: canvas.height - floorHeight,
  width: 40,
  height: 40,
  speed: 5,
  active: false
};

const gravitySwitch = {
  x: canvas.width + 200,
  y: canvas.height - floorHeight - 60,
  radius: 60,
  speed: 5,
  active: false,
  used: false
};

const topSpike = {
  x: canvas.width + 300,
  y: ceilingHeight + 5,
  width: 40,
  height: 40,
  speed: 6,
  active: false
};

const mirror = {
  x: canvas.width / 2 + 150,
  y: canvas.height - floorHeight - 100,
  width: 80,
  height: 100,
  active: false,
  touched: false
};

let mirrorTimerStarted = false;
let mirrorDirectionFlipped = false;

let secondSpikes = [];
let secondSpikeTimer1 = null;
let secondSpikeTimer2 = null;

let finishLine = {
  x: canvas.width + 800,
  y: canvas.height - floorHeight - 100,
  width: 40,
  height: 100,
  active: false
};

window.addEventListener("keydown", (e) => {
  if (e.code === "Space" && !player.isJumping) {
    player.ySpeed = jumpStrength * Math.sign(gravity);
    player.isJumping = true;
  }
});

function drawSpike(x, y, width, height) {
  ctx.fillStyle = "white";
  ctx.beginPath();
  ctx.moveTo(x, y + height);
  ctx.lineTo(x + width / 2, y);
  ctx.lineTo(x + width, y + height);
  ctx.closePath();
  ctx.fill();
}

function drawUpsideDownSpike(x, y, width, height) {
  ctx.fillStyle = "white";
  ctx.beginPath();
  ctx.moveTo(x, y);
  ctx.lineTo(x + width / 2, y + height);
  ctx.lineTo(x + width, y);
  ctx.closePath();
  ctx.fill();
}

function drawGravitySwitcher(switcher) {
  ctx.fillStyle = "yellow";
  ctx.beginPath();
  ctx.arc(switcher.x, switcher.y, switcher.radius, 0, Math.PI * 2);
  ctx.fill();
}

function isCollidingRect(a, b) {
  return (
    a.x < b.x + b.width &&
    a.x + a.width > b.x &&
    a.y < b.y + b.height &&
    a.y + a.height > b.y
  );
}

function isCollidingCircle(player, circle) {
  const dx = player.x + player.width / 2 - circle.x;
  const dy = player.y + player.height / 2 - circle.y;
  const distance = Math.sqrt(dx * dx + dy * dy);
  return distance < circle.radius + player.width / 2;
}

function endGame(text) {
  message.innerText = text;
  message.style.display = "block";
  setTimeout(() => location.reload(), 2000);
  cancelAnimationFrame(gameId);
}

setTimeout(() => spike.active = true, 2000);
setTimeout(() => gravitySwitch.active = true, 3000);

let gameId;

function gameLoop() {
  gameId = requestAnimationFrame(gameLoop);
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  // Floor & ceiling
  ctx.fillStyle = "#888";
  ctx.fillRect(0, 0, canvas.width, ceilingHeight);
  ctx.fillStyle = "#555";
  ctx.fillRect(0, canvas.height - floorHeight, canvas.width, floorHeight);

  // Gravity and movement
  player.ySpeed += gravity;
  player.y += player.ySpeed;

  if (gravity > 0 && player.y + player.height >= canvas.height - floorHeight) {
    player.y = canvas.height - floorHeight - player.height;
    player.ySpeed = 0;
    player.isJumping = false;
  } else if (gravity < 0 && player.y <= ceilingHeight) {
    player.y = ceilingHeight;
    player.ySpeed = 0;
    player.isJumping = false;
  }

  // Player
  ctx.fillStyle = "rgb(20, 28, 255)";
  ctx.fillRect(player.x, player.y, player.width, player.height);

  // First spike
  if (spike.active && !mirror.touched) {
    spike.x -= spike.speed;
    drawSpike(spike.x, spike.y - spike.height, spike.width, spike.height);
    if (isCollidingRect(player, {
      x: spike.x,
      y: spike.y - spike.height,
      width: spike.width,
      height: spike.height
    })) {
      endGame("You Died");
    }
  }

  // Gravity switch
  if (gravitySwitch.active && !gravitySwitch.used) {
    gravitySwitch.x -= gravitySwitch.speed;
    drawGravitySwitcher(gravitySwitch);
    if (isCollidingCircle(player, gravitySwitch)) {
      gravity *= -1;
      gravitySwitch.used = true;
      topSpike.active = true;
      topSpike.x = canvas.width + 100;

      setTimeout(() => {
        mirror.active = true;
      }, 1000);
    }
  }

  // Top spike
  if (topSpike.active && !mirror.touched) {
    topSpike.x -= topSpike.speed;
    drawUpsideDownSpike(topSpike.x, topSpike.y, topSpike.width, topSpike.height);
    if (isCollidingRect(player, {
      x: topSpike.x,
      y: topSpike.y,
      width: topSpike.width,
      height: topSpike.height
    })) {
      endGame("You Died");
    }
  }

  // Mirror
  if (mirror.active && !mirror.touched) {
    ctx.fillStyle = "cyan";
    ctx.fillRect(mirror.x, mirror.y, mirror.width, mirror.height);
    if (isCollidingRect(player, mirror)) {
      mirror.touched = true;

      // Start 2 new spikes from left to right
      secondSpikes.push({
        x: -100,
        y: canvas.height - floorHeight,
        width: 40,
        height: 40,
        speed: 5
      });

      setTimeout(() => {
        secondSpikes.push({
          x: -100,
          y: canvas.height - floorHeight,
          width: 40,
          height: 40,
          speed: 5
        });
      }, 800);

      setTimeout(() => {
        finishLine.active = true;
      }, 1600);
    }
  }

  // Second spike wave (right-moving)
  secondSpikes.forEach(s => {
    s.x += s.speed;
    drawSpike(s.x, s.y - s.height, s.width, s.height);
    if (isCollidingRect(player, {
      x: s.x,
      y: s.y - s.height,
      width: s.width,
      height: s.height
    })) {
      endGame("You Died");
    }
  });

  // Finish line
  if (finishLine.active) {
    ctx.fillStyle = "lime";
    ctx.fillRect(finishLine.x, finishLine.y, finishLine.width, finishLine.height);
    finishLine.x -= 3;

    if (isCollidingRect(player, finishLine)) {
      endGame("You Won!");
    }
  }
}

gameLoop();
</script>
</body>
</html>